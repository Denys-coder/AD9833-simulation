<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>AD9833 simulation</title>
        <link rel="stylesheet" href="../css/styles.css">
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
            let intervalID;
            function generateGraph()
            {
                clearInterval(intervalID);
                
                // values of html fields (datatype is number)
                let freq0Reg = parseInt(document.getElementById("freq0_reg").value, 2);
                let freq1Reg = parseInt(document.getElementById("freq1_reg").value, 2);
                let phaseAccumulator = parseInt(document.getElementById("phase_accumulator").value, 2);
                let phase0Reg = parseInt(document.getElementById("phase0_reg").value, 2);
                let phase1Reg = parseInt(document.getElementById("phase1_reg").value, 2);
                let controlRegister = parseInt(document.getElementById("control_register").value, 2);
                let baseFrequency = 1 / (parseInt(document.getElementById("base_frequency").value) * parseInt(document.getElementById("base_frequency_unit").value));
                alert(baseFrequency * 1000);
        
                // registers data (datatype is boolean)
                let d1 = (controlRegister & 0b0_000_000_000_000_010) === 0; // 'true' for bypass "SIN ROM" and 'false' for "SIN ROM"
                let d10 = (controlRegister & 0b0_000_010_000_000_000) === 0; // 'true' for "PHASE1 REG" and 'false' for "PHASE0 REG"
                let d11 = (controlRegister & 0b0_000_100_000_000_000) === 0; // 'true' for "FREQ1 REG" and 'false' for "FREQ0 REG"
        
                const graphData = [{
                    x: [],
                    y: [],
                    mode: "lines"
                }];
        
                const graphLayout = {
                    title: "Dynamic Function Graph",
                    xaxis: {
                        title: "X-axis",
                    },
                    yaxis: {
                        title: "Y-axis",
                    },
                };
                const graphContainer = document.getElementById("graphContainer");
                Plotly.purge(graphContainer);
                Plotly.newPlot("graphContainer", graphData, graphLayout);
        
                // phaseAccumulator already defined
                let centralSum = 0;
                let sinRomOutput = 0;
                let DAC10bit = 0;
                let i = 0;
    
                let start = performance.now();
                intervalID = setInterval(function()
                {
                    let mux1 = d11 ? freq0Reg : freq1Reg;
                    phaseAccumulator = (mux1 + phaseAccumulator) & 0xfffffff;
                    let mux2 = d10 ? phase0Reg : phase1Reg;
                    centralSum = phaseAccumulator + mux2;
                    // angle in radians
                    let sinRomInput = ((2 * Math.PI) / (Math.pow(2, 12) - 1)) * centralSum;
                    let sinRom = Math.sin(sinRomInput + sinRomInput);
                    sinRomOutput = (1 / (Math.pow(2, 10) - 1)) * sinRom;
                    let mux4 = d1 ? sinRomOutput : sinRomInput;
                    DAC10bit = (DAC10bit + ((0.7 / (Math.pow(2, 10) - 1)) * mux4));

                    Plotly.extendTraces("graphContainer", {x: [[i]], y: [[DAC10bit]]}, [0]);
                    i++;
    
                    let now = performance.now();
                    console.log(performance.now() - start);
                    start = now;
                    
                }, baseFrequency * 1000);
            }
        </script>
    </head>
    <body>
        
        <img src="../images/img.png" id="scheme_image" width="1310" height="688" alt="control schema">
        <br>
        
        <label for="freq0_reg">FREQ0 REG (28 bit)</label>
        <br>
        <input type="text" id="freq0_reg" value="0110011000111001101001110001" size="40">
        <br>
        <br>
        
        <label for="freq1_reg">FREQ1 REG (28 bit)</label>
        <br>
        <input type="text" id="freq1_reg" value="011001010100010101000111101" size="40">
        <br>
        <br>
        
        <label for="phase_accumulator">PHASE ACCUMULATOR (28-BIT)</label>
        <br>
        <input type="text" id="phase_accumulator" value="0001101010001101010110010101" size="40">
        <br>
        <br>
        
        <label for="phase0_reg">PHASE0 REG (12 bit)</label>
        <br>
        <input type="text" id="phase0_reg" value="100101010111" size="40">
        <br>
        <br>
        
        <label for="phase1_reg">PHASE1 REG (12 bit)</label>
        <br>
        <input type="text" id="phase1_reg" value="001010100011" size="40">
        <br>
        <br>
        
        <label for="control_register">CONTROL REGISTER (16 bit)</label>
        <br>
        <input type="text" id="control_register" value="0011010101000100" size="40">
        <br>
        <br>
        
        <label for="base_frequency">base frequency</label>
        <br>
        <input type="text" id="base_frequency" value="100">
        <select id="base_frequency_unit">
            <option value="1">Hz</option>
            <option value="1000">KHz</option>
            <option value="1000000">MHz</option>
            <option value="1000000000">GHz</option>
        </select>
        <br>
        <br>
        
        <button onclick="generateGraph()" id="generate_graph">Generate data</button>
        
        <div id="graphContainer"></div>
        
    </body>
</html>